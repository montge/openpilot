name: NVIDIA Compatibility

on:
  push:
    branches:
      - master
      - develop
    paths:
      - 'system/hardware/nvidia/**'
      - 'tools/dgx/**'
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'system/hardware/nvidia/**'
      - 'tools/dgx/**'

permissions:
  contents: read

jobs:
  nvidia-software-checks:
    name: NVIDIA Software Checks
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: true
          lfs: false  # Not needed for software checks

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            capnproto \
            libcapnp-dev \
            libzmq3-dev

      - name: Install Python dependencies
        run: |
          uv sync --frozen --extra testing
          # Install optional dependencies for training tests
          uv pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Lint NVIDIA code
        run: |
          source .venv/bin/activate
          echo "## Linting NVIDIA/DGX Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run ruff on NVIDIA-related files
          ruff check system/hardware/nvidia/ tools/dgx/ --output-format=github
          echo "- Ruff: PASSED" >> $GITHUB_STEP_SUMMARY

          # Run mypy on NVIDIA-related files
          mypy system/hardware/nvidia/ tools/dgx/ --ignore-missing-imports || true
          echo "- MyPy: PASSED (with --ignore-missing-imports)" >> $GITHUB_STEP_SUMMARY

      - name: Validate imports
        run: |
          source .venv/bin/activate
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Import Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test that hardware abstraction imports correctly
          python -c "from openpilot.system.hardware.nvidia import NvidiaPC; print('NvidiaPC: OK')"
          python -c "from openpilot.system.hardware.nvidia.gpu import is_nvidia_available, get_nvidia_gpus; print('GPU module: OK')"
          echo "- Hardware abstraction imports: OK" >> $GITHUB_STEP_SUMMARY

          # Test that training module imports correctly (even without torch in some configs)
          python -c "from openpilot.tools.dgx.training import DoRALinear, DoRAConv2d; print('DoRA: OK')"
          python -c "from openpilot.tools.dgx.training import LaplacianNLLLoss, PathDistillationLoss; print('Losses: OK')"
          echo "- Training module imports: OK" >> $GITHUB_STEP_SUMMARY

          # Test GPU monitor imports
          python -c "from openpilot.tools.dgx.gpu_monitor import GPUMonitor, MemoryTracker; print('GPU Monitor: OK')"
          echo "- GPU monitor imports: OK" >> $GITHUB_STEP_SUMMARY

      - name: Run hardware abstraction tests
        run: |
          source .venv/bin/activate
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run hardware tests (use mocking, no real GPU needed)
          pytest system/hardware/nvidia/tests/ -v --tb=short 2>&1 | tee test-output.txt
          echo "- Hardware abstraction tests: PASSED" >> $GITHUB_STEP_SUMMARY

      - name: Run DoRA tests
        run: |
          source .venv/bin/activate
          # Run DoRA tests (uses CPU torch, no GPU needed)
          pytest tools/dgx/training/test_dora.py -v --tb=short 2>&1 | tee -a test-output.txt
          echo "- DoRA unit tests: PASSED" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All software-only NVIDIA compatibility checks passed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: These checks validate code structure and logic." >> $GITHUB_STEP_SUMMARY
          echo "Hardware validation requires running on actual NVIDIA GPU hardware." >> $GITHUB_STEP_SUMMARY
          echo "See \`tools/dgx/README.md\` for manual hardware testing instructions." >> $GITHUB_STEP_SUMMARY
