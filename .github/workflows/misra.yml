name: MISRA Analysis

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

jobs:
  cppcheck-misra:
    name: cppcheck MISRA C:2012
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck MISRA analysis
        run: |
          ./scripts/lint/cppcheck-misra.sh 2>&1 | tee cppcheck-misra-output.txt || true

      - name: Parse MISRA findings
        run: |
          echo "## cppcheck MISRA C:2012 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          FINDINGS=$(grep -c "misra-c2012" cppcheck-misra-output.txt 2>/dev/null || echo "0")
          echo "**Total findings:** $FINDINGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Top 10 Rules" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -oE "misra-c2012-[0-9]+\.[0-9]+" cppcheck-misra-output.txt 2>/dev/null | \
            sort | uniq -c | sort -rn | head -10 >> $GITHUB_STEP_SUMMARY || echo "No findings" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload MISRA report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-misra-report
          path: cppcheck-misra-output.txt
          retention-days: 30

  # clang-tidy-automotive job (optional - requires custom build)
  # Uncomment when clang-tidy-automotive is available in CI
  #
  # clang-tidy-automotive:
  #   name: clang-tidy MISRA 2023/2025
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         submodules: true
  #
  #     - name: Run clang-tidy-automotive
  #       run: |
  #         ./scripts/lint/clang-tidy-misra.sh 2>&1 | tee clang-tidy-misra-output.txt || true
